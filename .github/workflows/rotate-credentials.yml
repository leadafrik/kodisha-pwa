name: ðŸ”„ Monthly Credential Rotation

on:
  schedule:
    # Run on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes)?'
        required: false
        default: 'false'

jobs:
  rotate-credentials:
    name: Rotate All Credentials
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: |
          npm install axios crypto dotenv

      - name: ðŸ”„ Rotate Credentials
        run: |
          node scripts/rotate-credentials.js ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
        env:
          # MongoDB Atlas API Keys
          MONGODB_ORG_ID: ${{ secrets.MONGODB_ORG_ID }}
          MONGODB_PROJECT_ID: ${{ secrets.MONGODB_PROJECT_ID }}
          MONGODB_PUBLIC_KEY: ${{ secrets.MONGODB_PUBLIC_KEY }}
          MONGODB_PRIVATE_KEY: ${{ secrets.MONGODB_PRIVATE_KEY }}
          
          # Render API
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          
          # Vercel API
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          
          # Slack Notifications
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: âœ… Verify Backend Health
        run: |
          echo "â³ Waiting 30s for Render to finish deploying..."
          sleep 30
          
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          echo "ðŸ” Checking backend health: $BACKEND_URL/api/auth/health"
          
          # Retry up to 5 times with 10s delay
          for i in {1..5}; do
            if curl -f -s "$BACKEND_URL/api/auth/health" > /dev/null; then
              echo "âœ… Backend is healthy!"
              exit 0
            fi
            
            if [ $i -lt 5 ]; then
              echo "â³ Attempt $i failed, retrying in 10s..."
              sleep 10
            fi
          done
          
          echo "âŒ Backend health check failed after 5 attempts"
          exit 1

      - name: ðŸ“Š Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: rotation-logs
          path: |
            .secrets-backup/
            rotation-*.log
          retention-days: 30

      - name: ðŸ”´ Notify Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âŒ Credential rotation FAILED!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Credential rotation failed. Check the workflow logs immediately."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'

      - name: ðŸ“ Create backup summary
        if: success()
        run: |
          cat > ROTATION_SUMMARY.md << 'EOF'
          # Credential Rotation Summary
          
          **Date:** $(date)
          **Triggered by:** ${{ github.event_name }}
          **Status:** âœ… Success
          
          ## What Was Rotated
          - âœ… MongoDB Atlas Password
          - âœ… JWT Secret
          
          ## Deployment Status
          - âœ… Render backend redeployed
          - âœ… Backend health check passed
          
          ## Next Steps
          1. âœ… Automated - No manual action needed
          2. Monitor backend logs for next 24 hours
          3. Next rotation scheduled: 1st of next month
          
          ## Rollback (If Needed)
          See ROLLBACK.md in repository root
          EOF
          cat ROTATION_SUMMARY.md

      - name: ðŸ’¾ Save summary as artifact
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: rotation-summary
          path: ROTATION_SUMMARY.md
